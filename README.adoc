= Istio Distributed Tracing Mission

== Purpose
Showcase Istio's Distributed Tracing via a (minimally) instrumented set of Spring Boot applications

== Prerequisites
. JDK 11+ installed with JAVA_HOME configured appropriately
. Openshift 4.7 cluster
. Istio installed on the aforementioned cluster using the link:https://docs.openshift.com/container-platform/4.7/service_mesh/v1x/installing-ossm.html[Red Hat OpenShift Service Mesh Operator].
. Login to the cluster with the *admin* user

== Environment preparation

Create a new project/namespace on the cluster. This is where your application will be deployed.

```bash
oc new-project <whatever valid project name you want>
```

Add the `<whatever valid project name you want>` project to the Istio member roll. More information in this link:https://docs.openshift.com/container-platform/4.7/service_mesh/v1x/installing-ossm.html#ossm-member-roll-modify-cli_installing-ossm-v1x[link].

== Build and deploy the application

=== With Dekorate:
Execute the following command to build the project and deploy it to OpenShift:
```bash
mvn clean verify -Popenshift -Ddekorate.deploy=true
```

This configuration is used to define service names and deployments that control how pods are labeled/versioned on the OpenShift cluster. Labels and versions are key concepts for creating load-balanced or multi-versioned pods in a service.


=== With Source to Image build (S2I)
Run the following commands to apply and execute the OpenShift templates that will configure and deploy the applications:
```bash
    find . | grep openshiftio | grep application | xargs -n 1 oc apply -f

    oc new-app --template=istio-distributed-tracing-example-greeting-service -p SOURCE_REPOSITORY_URL=https://github.com/snowdrop/istio-distributed-tracing-example -p SOURCE_REPOSITORY_REF=master -p SOURCE_REPOSITORY_DIR=spring-boot-istio-distributed-tracing-greeting-service
    oc new-app --template=istio-distributed-tracing-example-cute-name-service -p SOURCE_REPOSITORY_URL=https://github.com/snowdrop/istio-distributed-tracing-example -p SOURCE_REPOSITORY_REF=master -p SOURCE_REPOSITORY_DIR=spring-boot-istio-distributed-tracing-cute-name-service
```

== Use Cases

=== Access the application via the Istio ingress-gateway
. Create a RouteRule to forward traffic from istio-ingress to the demo application
+
```bash
oc create -f rules/greeting-gateway.yml
```
. Access the application
+
Run the following command to determine the appropriate URL to access our demo. Make sure you access the url with the HTTP scheme. HTTPS is NOT enabled by default:
+
```bash
echo http://$(oc get route istio-ingressgateway -o jsonpath='{.spec.host}{"\n"}' -n istio-system)/greeting/
```
+
The result of the above command is the istio-system istio-ingress URL, appended with the RouteRule path. Open this URL in your a web browser.
. Follow the instructions in the application UI

=== View application traces
. Access the Jaeger tracing dashboard
+
The traces from the invocation of the two endpoints should look like the following:
+
image::spring-boot-istio-distributed-tracing-greeting-service/src/main/resources/static/traces.jpg[]
+
Note that it could take a few seconds for all the spans to be collected and presented in a trace that matches the picture above


=== Undeploy the application

==== With Source to Image build (S2I)
```bash
oc delete all --all
oc delete ingress --all
find . | grep openshiftio | grep application | xargs -n 1 oc delete -f
```

==== Remove the namespace
This will delete the project from the OpenShift cluster
```bash
oc delete project <your project name>
```

== Integration tests

To run integration tests, create a new namespace and run maven job
```bash
oc new-project <project-name>
mvn clean verify -pl spring-boot-istio-distributed-tracing-cute-name-service -Popenshift -Ddekorate.deploy=true
mvn clean verify -pl spring-boot-istio-distributed-tracing-greeting-service -Popenshift -Ddekorate.deploy=true
oc create -f rules/greeting-gateway.yml
mvn clean verify -pl tests -Popenshift-it
```
